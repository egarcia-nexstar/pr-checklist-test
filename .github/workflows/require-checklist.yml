name: Require Checklist

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  job1:
    runs-on: ubuntu-latest
    steps:
      - uses: mheap/require-checklist-action@v2
        with:
          requireChecklist: true

      - name: Fail if any checklist item is "No"
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking for 'No' selections in PR checklist..."
          if echo "$PR_BODY" | grep -q "\- \[x\] No"; then
            echo "❌ One or more checklist items are marked 'No'."
            exit 1
          fi
          echo "✅ No 'No' selections found."

      - name: Download previous PR body
        uses: actions/download-artifact@v4
        with:
          name: pr-body-${{ github.event.pull_request.number }}
          path: previous
        continue-on-error: true

      - name: Generate audit log of newly checked items
        id: audit
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M UTC")"

          mkdir -p audit

          # Previous PR body (if exists)
          PREV_FILE="previous/pr-body.md"
          if [[ -f "$PREV_FILE" ]]; then
            # Extract previously checked items
            grep '\- \[x\]' "$PREV_FILE" > prev_checked.txt
          else
            touch prev_checked.txt
          fi

          # Extract currently checked items
          echo "$PR_BODY" > current_pr_body.md
          grep '\- \[x\]' current_pr_body.md > curr_checked.txt

          # Determine newly checked items (current - previous)
          comm -23 <(sort curr_checked.txt) <(sort prev_checked.txt) > new_checked.txt

          # Convert to Markdown table rows
          awk -v actor="$ACTOR" -v ts="$TIMESTAMP" '
            {print "| " substr($0,7) " | " actor " | " ts " |"}' new_checked.txt > audit/audit.log

          cat audit/audit.log

          # Expose as multi-line output
          echo "audit_table<<EOF" >> $GITHUB_OUTPUT
          cat audit/audit.log
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post newly checked items to PR comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Newly Checked PR Checklist Items
            | Checklist Item | Checked By | Timestamp |
            |----------------|-----------|-----------|
            ${{ steps.audit.outputs.audit_table }}
        if: github.event.pull_request.head.repo.full_name == github.repository

      - name: Upload audit log artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-checklist-audit-${{ github.event.pull_request.number }}
          path: audit/audit.log

      - name: Upload current PR body for next run
        uses: actions/upload-artifact@v4
        with:
          name: pr-body-${{ github.event.pull_request.number }}
          path: current_pr_body.md
