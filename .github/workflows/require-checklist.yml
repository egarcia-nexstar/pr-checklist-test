name: Require Checklist

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  checklist:
    runs-on: ubuntu-latest

    steps:
      # 1. Enforce that exactly one checkbox is selected per TaskRadio group
      - name: Require checklist selection
        uses: mheap/require-checklist-action@v2
        with:
          requireChecklist: true

      # 2. Fail the PR if ANY "No" option is checked
      - name: Fail if any 'No' is selected
        run: |
          echo "Checking for 'No' selections..."
          if printf "%s\n" "${{ github.event.pull_request.body }}" | grep -q '\- \[x\] No'; then
            echo "❌ One or more checklist items are marked 'No'."
            exit 1
          fi
          echo "✅ No 'No' selections found."

      # 3. Generate FULL checklist audit (entire form, every run)
      - name: Generate full checklist audit
        id: audit
        shell: bash
        run: |
          set -euo pipefail

          PR_BODY="${{ github.event.pull_request.body }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M UTC")"

          mkdir -p audit

          # Normalize CRLF → LF
          printf "%s\n" "$PR_BODY" | tr -d '\r' > audit/body.txt

          CURRENT_SECTION=""

          {
            echo "| Section | Item | Status | Actor | Timestamp |"
            echo "|--------|------|--------|-------|-----------|"

            while IFS= read -r line; do
              # Section headers
              if [[ "$line" =~ ^###[[:space:]]+(.*)$ ]]; then
                CURRENT_SECTION="${BASH_REMATCH[1]}"
                continue
              fi

              # Checklist items
              if [[ "$line" =~ ^-[[:space:]]+\[[x[:space:]]\][[:space:]]+(.*)$ ]]; then
                ITEM="${BASH_REMATCH[1]}"
                STATUS="Unchecked"

                [[ "$line" =~ \[x\] ]] && STATUS="Checked"

                # Remove HTML comments
                ITEM="$(sed 's/<!--.*-->//g' <<< "$ITEM" | xargs)"

                echo "| $CURRENT_SECTION | $ITEM | $STATUS | $ACTOR | $TIMESTAMP |"
              fi
            done < audit/body.txt
          } > audit/audit.log

          # Expose as multiline output (this is critical)
          echo "audit_table<<EOF" >> "$GITHUB_OUTPUT"
          sed '1,2d' audit/audit.log >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # 4. Post audit comment to PR
      - name: Post checklist audit to PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## PR Checklist Audit (Current State)

            | Section | Item | Status | Actor | Timestamp |
            |--------|------|--------|-------|-----------|
            ${{ steps.audit.outputs.audit_table }}

      # 5. Upload audit artifact (optional but useful)
      - name: Upload audit artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-checklist-audit-${{ github.event.pull_request.number }}
          path: audit/audit.log

