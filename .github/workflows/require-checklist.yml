name: Require Checklist

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  job1:
    runs-on: ubuntu-latest
    steps:
      - uses: mheap/require-checklist-action@v2
        with:
          requireChecklist: true

      - name: Fail if any 'No' is selected
        id: fail_no
        run: |
          echo "Checking for 'No' selections..."
          if echo "${{ github.event.pull_request.body }}" | grep -q "\- \[x\] No"; then
            echo "❌ One or more checklist items are marked 'No'. Failing PR."
            exit 1
          fi
          echo "✅ No 'No' selections found."

      - name: Generate audit log
        id: audit
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M UTC")"

          mkdir -p audit

          # Convert all checked items into Markdown table rows
          awk -v actor="$ACTOR" -v ts="$TIMESTAMP" '
            /^- \[x\]/ {
              item = substr($0,7)  # remove leading "- [x] "
              print "| " item " | " actor " | " ts " |"
            }' <<< "$PR_BODY" > audit/audit.log

          # Expose as multi-line output (preserves newlines)
          echo "audit_table<<EOF" >> $GITHUB_OUTPUT
          cat audit/audit.log
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post audit comment to PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## PR Checklist Audit
            | Checklist Item | Checked By | Timestamp |
            |----------------|-----------|-----------|
            ${{ steps.audit.outputs.audit_table }}

      - name: Upload audit artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-checklist-audit-${{ github.event.pull_request.number }}
          path: audit/audit.log
